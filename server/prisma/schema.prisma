generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum InterestedIn {
  MALE
  FEMALE
  BOTH
}

enum VerificationStatus {
  NONE
  PENDING
  APPROVED
  REJECTED
}

enum UserStatus {
  ACTIVE
  FROZEN       // Kullanıcı hesabını dondurdu - aynı telefonla tekrar giriş yapınca aktifleşir
  SHADOWBANNED
  BANNED
}

enum CardCategory {
  LIFESTYLE
  VALUES
  INTERESTS
  PERSONALITY
  HUMOR
}

enum QuestionCategory {
  RELATIONSHIPS  // İlişkiler
  HOBBIES        // Hobiler
  VALUES         // Değerler
  LIFESTYLE      // Yaşam Tarzı
  FUTURE_PLANS   // Gelecek Planları
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ReportCategory {
  SPAM
  HARASSMENT
  FAKE_PROFILE
  INAPPROPRIATE_CONTENT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
}

enum RedeemStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdminRole {
  SUPER_ADMIN
  MODERATOR
}

enum Platform {
  IOS
  ANDROID
}

enum ChatEndReason {
  CARDS_MISMATCH
  DISCONNECTED
  BLOCKED
  TIMEOUT
  USER_ENDED
}

enum MessageType {
  TEXT
  MEDIA
  TOKEN_GIFT
  SYSTEM
}

model User {
  id                     String        @id @default(uuid())
  
  // ============ AUTH ALANLARI ============
  phoneNumber            String?       @unique  // Telefon ile giriş (opsiyonel)
  email                  String?       @unique  // E-posta ile giriş (opsiyonel)
  passwordHash           String?                // E-posta girişi için şifre hash
  googleId               String?       @unique  // Google OAuth ID
  appleId                String?       @unique  // Apple OAuth ID
  emailVerified          Boolean       @default(false)
  authProvider           String        @default("phone") // phone, email, google, apple
  
  // Refresh Token (session yönetimi)
  refreshToken           String?
  refreshTokenExp        DateTime?
  
  // ============ ONBOARDING DURUMU ============
  profileComplete        Boolean       @default(false)  // Profil tamamlandı mı?
  onboardingStep         Int           @default(1)      // Kaldığı onboarding adımı (1-3)
  frozenAt               DateTime?                       // Hesap ne zaman donduruldu
  
  // ============ PROFİL ALANLARI ============
  nickname               String        @unique
  age                    Int
  birthDate              DateTime?     // Doğum tarihi
  gender                 Gender
  interestedIn           InterestedIn
  bio                    String?       @db.VarChar(150)
  interests              String[]      // İlgi alanları tagleri
  city                   String
  country                String        @default("TR")
  latitude               Float?        // Konum - enlem
  longitude              Float?        // Konum - boylam
  avatarId               Int           @default(1)  // 1-8 arası varsayılan avatar
  profilePhotoUrl        String?                    // Prime üyeler için özel profil fotoğrafı
  profilePhotos          Photo[]
  verificationVideoUrl   String?
  verified               Boolean       @default(false)
  verificationStatus     VerificationStatus @default(NONE)
  isPlus                 Boolean       @default(false)
  plusExpiresAt          DateTime?
  isPrime                Boolean       @default(false)
  primeExpiry            DateTime?
  // Prime filtre ayarları
  filterMinAge           Int           @default(18)
  filterMaxAge           Int           @default(99)
  filterMaxDistance      Int           @default(160)  // km cinsinden
  filterGender           String        @default("BOTH") // MALE, FEMALE, BOTH - 50 elmas ile Kadın/Erkek, 30 dk geçerli
  filterGenderExpiresAt  DateTime?                        // Kadın/Erkek tercihi bitiş (30 dk)
  preferHighSpark        Boolean       @default(false)  // Prime: en yüksek sparklı kişilerle eşleş (aç/kapa)
  tokenBalance           Int           @default(0)
  monthlyTokensReceived  Int           @default(0)  // Hediye olarak aldığı tokenlar
  monthlyTokensEarned    Int           @default(0)  // Hediye olarak kazandığı tokenlar
  totalTokensEarned      Int           @default(0)  // Toplam kazanılan tokenlar (lifetime)
  monthlySparksEarned    Int           @default(0)  // Medya açılmasından kazanılan sparklar (leaderboard için)
  totalSparksEarned      Int           @default(0)  // Toplam kazanılan sparklar (lifetime)
  monthlyResetAt         DateTime      @default(now()) // Son aylık sıfırlama tarihi
  
  // ============ GÜNLÜK ÖDÜL SİSTEMİ ============
  lastDailyRewardAt      DateTime?                       // Son günlük ödül alma zamanı
  currentStreak          Int           @default(0)       // Mevcut ardışık giriş sayısı
  longestStreak          Int           @default(0)       // En uzun ardışık giriş
  
  // ============ BOOST SİSTEMİ ============
  isBoostActive          Boolean       @default(false)  // Boost aktif mi
  boostExpiresAt         DateTime?                       // Boost bitiş tarihi
  boostCount             Int           @default(0)       // Toplam kullanılan boost sayısı
  
  // ============ ÖZEL ETKİNLİK ERİŞİMİ ============
  hasEventAccess         Boolean       @default(false)  // Özel etkinlik erişim hakkı
  eventAccessGrantedAt   DateTime?                       // Erişim verilme tarihi
  eventAccessExpiresAt   DateTime?                       // Erişim bitiş tarihi (opsiyonel)
  dailyChatsStarted      Int           @default(0)   // Bugün başlatılan sohbet sayısı
  dailyChatsResetAt      DateTime      @default(now()) // Günlük sıfırlama tarihi
  status                 UserStatus    @default(ACTIVE)
  reportCount            Int           @default(0)
  positiveRatings        Int           @default(0)  // İyi kullanıcı beğeni sayısı
  negativeRatings        Int           @default(0)  // Beğenilmeyen kullanıcı sayısı
  isOnline               Boolean       @default(false)
  lastSeenAt             DateTime?
  expoPushToken          String?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relations
  matchesAsUser1         Match[]       @relation("User1Matches")
  matchesAsUser2         Match[]       @relation("User2Matches")
  matchHistoriesAsUser1  MatchHistory[] @relation("User1MatchHistories")
  matchHistoriesAsUser2  MatchHistory[] @relation("User2MatchHistories")
  messages               Message[]     @relation("UserMessages")
  blocksInitiated        Block[]       @relation("BlocksInitiated")
  blocksReceived         Block[]       @relation("BlocksReceived")
  reportsMade            Report[]      @relation("ReportsMade")
  reportsReceived        Report[]      @relation("ReportsReceived")
  giftsSent              Gift[]        @relation("GiftsSent")
  giftsReceived          Gift[]        @relation("GiftsReceived")
  friendRequestsSent     FriendRequest[] @relation("FriendRequestsSent")
  friendRequestsReceived FriendRequest[] @relation("FriendRequestsReceived")
  friendshipsAsUser1     Friendship[]  @relation("FriendshipUser1")
  friendshipsAsUser2     Friendship[]  @relation("FriendshipUser2")
  verificationVideo       VerificationVideo[]
  friendChatMessagesSent FriendChatMessage[] @relation("SentMessages")
  plusSubscriptions      PlusSubscription[]
  tokenPurchases         TokenPurchase[]
  redeemRequests         RedeemRequest[]
  rewardClaims           RewardClaim[]

  // ============ PERFORMANS İNDEKSLERİ ============
  @@index([status])                           // Aktif kullanıcı sorguları
  @@index([gender, interestedIn, status])     // Eşleşme algoritması
  @@index([isOnline, status])                 // Online kullanıcılar
  @@index([city, status])                     // Şehir bazlı arama
  @@index([latitude, longitude])              // Konum bazlı arama
  @@index([tokenBalance])                     // Token sıralaması
  @@index([monthlySparksEarned])              // Leaderboard
  @@index([createdAt])                        // Yeni kullanıcılar
  @@index([lastSeenAt])                       // Son görülme
}

enum PhotoType {
  CORE    // Kalıcı profil fotoğrafları (max 6)
  DAILY   // Günlük fotoğraflar (günde max 3)
}

model Photo {
  id        String    @id @default(uuid())
  userId    String
  url       String
  order     Int
  type      PhotoType @default(CORE)  // core veya daily
  approved  Boolean   @default(false)
  caption   String?   @db.VarChar(80)  // Fotoğraf açıklaması (max 80 char)
  createdAt DateTime  @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  unlocks   PhotoUnlock[]

  @@index([userId])
  @@index([userId, type])  // Tip bazlı sorgular için
  @@index([userId, type, createdAt])  // Günlük foto sorguları için
}

// Fotoğraf açma kayıtları (hangi kullanıcı hangi fotoğrafı açtı)
model PhotoUnlock {
  id          String   @id @default(uuid())
  photoId     String
  viewerId    String   // Fotoğrafı açan kullanıcı
  ownerId     String   // Fotoğrafın sahibi
  tokenCost   Int      // Harcanan jeton
  sparkAmount Int      // Sahibine verilen spark
  createdAt   DateTime @default(now())

  photo       Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, viewerId])  // Aynı fotoğraf aynı kişi tarafından bir kez açılabilir
  @@index([viewerId])
  @@index([ownerId])
}

// Spark işlem geçmişi (leaderboard ve audit için)
model SparkTransaction {
  id          String   @id @default(uuid())
  fromUserId  String   // Spark gönderen (fotoğrafı açan)
  toUserId    String   // Spark alan (fotoğraf sahibi)
  photoId     String?  // İlgili fotoğraf (varsa)
  amount      Int      // Spark miktarı
  reason      String   // 'photo_unlock', 'gift', vb.
  createdAt   DateTime @default(now())

  @@index([fromUserId])
  @@index([toUserId])
  @@index([createdAt])
}

model VerificationVideo {
  id        String   @id @default(uuid())
  userId    String   @unique
  url       String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============ SELFİE DOĞRULAMA SİSTEMİ ============
enum VerificationPose {
  THUMBS_UP          // Başparmak yukarı
  PEACE_SIGN         // V işareti
  WAVE_HAND          // El sallama
  POINT_UP           // Yukarı işaret
  OK_SIGN            // OK işareti
}

model VerificationRequest {
  id              String             @id @default(uuid())
  userId          String
  pose            VerificationPose   // İstenen poz
  selfieUrl       String             // Yüklenen selfie URL
  status          VerificationStatus @default(PENDING)
  reviewedBy      String?            // Admin ID
  reviewNote      String?            // Admin notu (red sebebi vb.)
  reviewedAt      DateTime?
  createdAt       DateTime           @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Card {
  id          String       @id @default(uuid())
  questionTR  String
  category    CardCategory
  optionsJson String       // JSON stringified array of 4 options
  createdAt   DateTime     @default(now())
}

// ============ YENİ SORU SİSTEMİ ============

model Question {
  id          String             @id @default(uuid())
  text        String             // Soru metni
  category    QuestionCategory
  difficulty  QuestionDifficulty @default(MEDIUM)
  usageCount  Int                @default(0)  // Kaç kez soruldu
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  answers     Answer[]
  userAnswers UserAnswer[]

  @@index([category])
  @@index([usageCount])
  @@index([isActive])
}

model Answer {
  id              String   @id @default(uuid())
  questionId      String
  text            String   // Cevap metni
  value           Int      // 1-4 arası değer (A=1, B=2, C=3, D=4)
  personalityTrait String? // Opsiyonel: ROMANTIC, ADVENTUROUS, HOMEBODY vb.
  createdAt       DateTime @default(now())

  question        Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userAnswers     UserAnswer[]

  @@index([questionId])
}

model UserAnswer {
  id          String   @id @default(uuid())
  userId      String
  questionId  String
  answerId    String
  matchId     String   // Hangi match için cevaplandı
  createdAt   DateTime @default(now())

  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer      Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId, matchId])  // Aynı matchte aynı soruya 1 cevap
  @@index([userId])
  @@index([matchId])
  @@index([questionId])
}

// Match kartları için oyun durumu (real-time sync için)
model MatchCardGame {
  id              String   @id @default(uuid())
  matchId         String   @unique
  user1Id         String
  user2Id         String
  questionIds     String[] // 5 soru ID'si
  user1Progress   Int      @default(0)  // 0-5 arası
  user2Progress   Int      @default(0)  // 0-5 arası
  user1Completed  Boolean  @default(false)
  user2Completed  Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime // Timeout için

  @@index([matchId])
  @@index([user1Id])
  @@index([user2Id])
}

model Match {
  id           String      @id @default(uuid())
  user1Id      String
  user2Id      String
  createdAt    DateTime    @default(now())
  chatUnlocked Boolean     @default(false)
  endedAt      DateTime?
  endReason    ChatEndReason?

  user1        User        @relation("User1Matches", fields: [user1Id], references: [id], onDelete: Cascade)
  user2        User        @relation("User2Matches", fields: [user2Id], references: [id], onDelete: Cascade)
  chatSessions ChatSession[]

  @@index([user1Id])
  @@index([user2Id])
}

model MatchHistory {
  id          String      @id @default(uuid())
  user1Id     String
  user2Id     String
  matchedAt   DateTime    @default(now())
  chatUnlocked Boolean    @default(false)
  endedAt     DateTime?
  endReason   ChatEndReason?

  user1       User        @relation("User1MatchHistories", fields: [user1Id], references: [id], onDelete: Cascade)
  user2       User        @relation("User2MatchHistories", fields: [user2Id], references: [id], onDelete: Cascade)

  @@index([user1Id])
  @@index([user2Id])
  @@index([matchedAt])
}

model ChatSession {
  id                 String      @id @default(uuid())
  matchId            String
  startedAt          DateTime    @default(now())
  currentStage       Int         @default(1)
  stageStartedAt     DateTime    @default(now())
  user1Id            String
  user2Id            String
  user1MessageCount  Int         @default(0)
  user2MessageCount  Int         @default(0)
  endedAt            DateTime?
  endReason          ChatEndReason?

  match              Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  messages           Message[]

  @@index([matchId])
}

model Message {
  id            String      @id @default(uuid())
  chatSessionId String
  senderId      String
  content       String?
  mediaUrl      String?
  mediaType     String?     // 'photo' | 'video' | 'voice'
  messageType   MessageType @default(TEXT)  // TEXT, MEDIA, TOKEN_GIFT, SYSTEM
  tokenAmount   Int?        // TOKEN_GIFT için hediye edilen miktar
  locked        Boolean     @default(false) // Medya kilitli mi? (açmak için token gerek)
  isFirstFree   Boolean     @default(false) // Bu gönderenin ilk medyası mı? (ücretsiz)
  mediaPrice    Int         @default(0)     // Açma maliyeti (photo:20, video:50, audio:5)
  viewedBy      String?     // Görüntüleyen kullanıcı ID
  viewedAt      DateTime?   // Görüntülenme zamanı
  createdAt     DateTime    @default(now())

  chatSession   ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)
  sender        User        @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatSessionId])
  @@index([senderId])
}

// Medya sayaç tablosu - "ilk ücretsiz" mantığı için
// Mesaj silindikten sonra bile sayaç korunur
model MediaCounter {
  id            String   @id @default(uuid())
  chatSessionId String
  senderId      String
  receiverId    String
  mediaType     String   // 'photo' | 'video' | 'audio'
  count         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([chatSessionId, senderId, mediaType])
  @@index([chatSessionId])
  @@index([senderId])
}

model Block {
  id             String   @id @default(uuid())
  blockerUserId  String
  blockedUserId  String
  reason         String?
  createdAt      DateTime @default(now())

  blocker        User     @relation("BlocksInitiated", fields: [blockerUserId], references: [id], onDelete: Cascade)
  blocked        User     @relation("BlocksReceived", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@index([blockerUserId])
  @@index([blockedUserId])
  @@unique([blockerUserId, blockedUserId])
}

model Report {
  id              String         @id @default(uuid())
  reporterUserId  String
  reportedUserId  String
  sessionId       String?
  category        ReportCategory
  description     String?
  screenshot      String?
  status          ReportStatus   @default(PENDING)
  adminNote       String?
  createdAt       DateTime       @default(now())

  reporter        User           @relation("ReportsMade", fields: [reporterUserId], references: [id], onDelete: Cascade)
  reported        User           @relation("ReportsReceived", fields: [reportedUserId], references: [id], onDelete: Cascade)

  @@index([reporterUserId])
  @@index([reportedUserId])
}

model Gift {
  id          String   @id @default(uuid())
  fromUserId  String
  toUserId    String
  sessionId   String?
  amount      Int
  message     String?  @db.VarChar(100)
  createdAt   DateTime @default(now())

  fromUser    User     @relation("GiftsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser      User     @relation("GiftsReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
}

model FriendRequest {
  id          String   @id @default(uuid())
  fromUserId  String
  toUserId    String
  sessionId   String?
  status      String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt   DateTime @default(now())
  respondedAt DateTime?

  fromUser    User     @relation("FriendRequestsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser      User     @relation("FriendRequestsReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
}

model Friendship {
  id        String   @id @default(uuid())
  user1Id   String
  user2Id   String
  createdAt DateTime @default(now())

  user1     User     @relation("FriendshipUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2     User     @relation("FriendshipUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  friendChats FriendChat[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model FriendChat {
  id            String      @id @default(uuid())
  friendshipId  String
  createdAt     DateTime    @default(now())

  friendship    Friendship  @relation(fields: [friendshipId], references: [id], onDelete: Cascade)
  messages      FriendChatMessage[]

  @@index([friendshipId])
}

model FriendChatMessage {
  id           String      @id @default(uuid())
  friendChatId String
  senderId     String
  content      String?
  mediaUrl     String?
  mediaType    String?
  locked       Boolean     @default(false) // Medya kilitli mi?
  isFirstFree  Boolean     @default(false) // Bu gönderenin ilk medyası mı?
  mediaPrice   Int         @default(0)     // Açma maliyeti
  readAt       DateTime?   // Mesaj okunduğunda set edilir
  createdAt    DateTime    @default(now())

  friendChat   FriendChat  @relation(fields: [friendChatId], references: [id], onDelete: Cascade)
  sender       User        @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([friendChatId])
  @@index([senderId])
}

// Arkadaş sohbeti medya sayaç tablosu
model FriendMediaCounter {
  id           String   @id @default(uuid())
  friendChatId String
  senderId     String
  receiverId   String
  mediaType    String   // 'photo' | 'video' | 'audio'
  count        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([friendChatId, senderId, mediaType])
  @@index([friendChatId])
  @@index([senderId])
}

model PlusSubscription {
  id                     String    @id @default(uuid())
  userId                 String
  productId              String
  platform               Platform
  originalTransactionId  String
  expiresAt              DateTime
  autoRenew              Boolean   @default(true)
  createdAt              DateTime  @default(now())

  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TokenPurchase {
  id            String    @id @default(uuid())
  userId        String
  productId     String
  platform      Platform
  receipt       String
  tokensGranted Int
  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RedeemRequest {
  id              String       @id @default(uuid())
  userId          String
  requestedAmount Int
  bankAccount     String
  status          RedeemStatus @default(PENDING)
  adminNote       String?
  createdAt       DateTime     @default(now())
  processedAt     DateTime?

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         AdminRole @default(MODERATOR)
  createdAt    DateTime  @default(now())
}

model RewardClaim {
  id          String   @id @default(uuid())
  userId      String
  month       DateTime // Ödül ayı
  rank        Int      // Sıralama (1, 2, 3)
  contactInfo String   // IBAN veya iletişim bilgisi
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, PAID
  adminNote   String?
  createdAt   DateTime @default(now())
  processedAt DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([month])
}

// ============ AYLIK LİDERLİK TABLOSU ARŞİVİ ============
model MonthlyLeaderboard {
  id          String   @id @default(uuid())
  userId      String
  month       Int      // 1-12
  year        Int      // 2024, 2025, vb.
  sparkCount  Int      // O ayki spark sayısı
  rank        Int      // Sıralama
  hasEventAccess Boolean @default(false) // Etkinlik erişimi kazandı mı
  createdAt   DateTime @default(now())

  @@unique([userId, month, year])  // Her kullanıcı için ayda bir kayıt
  @@index([month, year])
  @@index([rank])
}

// ============ BOOST SATIN ALMA GEÇMİŞİ ============
model BoostPurchase {
  id            String   @id @default(uuid())
  userId        String
  tokenCost     Int      @default(0) // Eski sistem için (artık kullanılmıyor)
  priceTL       Float?   // TL cinsinden fiyat (199.90)
  durationHours Int      // Boost süresi (saat)
  activatedAt   DateTime @default(now())
  expiresAt     DateTime
  transactionId String?  @unique // App Store / Play Store transaction ID
  purchaseToken String?  // IAP purchase token
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([activatedAt])
  @@index([transactionId])
}

